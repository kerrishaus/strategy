<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>strategy</title>
		<style>
			body
			{
			    margin: 0;
			    background: navy;
			    font-family: Tahoma;
			}
		</style>
		
		<script src="https://kerrishaus.com/assets/scripts/jquery-3.6.0.min.js"></script>
		
		<script src="https://portal.kerrishaus.com/assets/javascript/messages.js"></script>
		<link rel='stylesheet' href='https://portal.kerrishaus.com/assets/styles/messages.css' />
		
		<style>
		    #gameInterfaceContainer
		    {
		        box-sizing: border-box;
		        
		        pointer-events: none;
		        color: white;
		        
		        position: absolute;
		        z-index: 99999;
		        
		        width: 100vw;
		        height: 100vh;
		        
		        display: flex;
		        justify-content: center;
		        align-items: flex-end;
		    }
		    
		    #gameStatus[data-state='0']
		    {
		        --outline: darkblue;
		        --primary: blue;
		        --secondary: lightblue;
		    }
		    
		    #gameStatus[data-state='1']
		    {
		        --outline: darkred;
		        --primary: red;
		        --secondary: purple; /* find a light red */
		    }
		    
		    #gameStatus[data-state='2']
		    {
		        --outline: darkgreen;
		        --primary: green;
		        --secondary: lightgreen;
		    }
		    
		    #gameStatus
		    {
		        --color-fade-time: 0.3s;
		        
		        display: flex;
		        flex-direction: row;
		        align-items: center;
		        
		        padding-bottom: 40px;
		    }
		    
		    #me
		    {
		        width: 128px;
		        height: 128px;
		        
		        background-color: var(--primary);
		        
		        border-radius: 100%;
		        border: 10px solid var(--outline);
		        
		        display: flex;
		        flex-direction: column;
		        align-items: center;
		        justify-content: flex-end;
		        
                position: relative;
                left: 26px;
                
                transition: background-color var(--color-fade-time), border-color var(--color-fade-time);
		    }
		    
		    #playerPortrait
		    {
		        background-color: var(--outline);
		        min-height: 96px;
		        width: 64px;
		        
		        border-radius: 10px;
		        
		        position: relative;
		        top: 5px;
		        
		        transition: background-color var(--color-fade-time), border-color var(--color-fade-time);
		    }
		    
		    #roundStatus
		    {
		        background-color: #222222bb;
		        padding: 18px 40px;
		        text-align: center;
		        
		        transition: background-color var(--color-fade-time), border-color var(--color-fade-time);
		    }
		    
		    #flag
		    {
		        display: inline-block;
		        
		        width: 26px;
		        height: 14px;
		        
		        border-radius: 3px;
		        
		        background-color: red;
		    }
		    
		    #playerName
		    {
		        font-size: 24px;
		        padding: 0px 10px;
		    }
		    
		    #tags
		    {
		        padding: 2px 4px;
		        font-size: 12px;
		        border-radius: 100%;
		        background-color: var(--outline);
		    }
		    
		    #roundType
		    {
		        display: flex;
		        gap: 5px;
		        
		        padding-top: 8px;
		        padding-bottom: 5px;
		    }
		    
		    .roundSpace
		    {
		        height: 12px;
		        
		        background-color: black;
		        
		        border-radius: 5px;
		        
		        flex-grow: 1;
		        
		        transition: background-color var(--color-fade-time), border-color var(--color-fade-time);
		    }
		    
		    .roundSpace.active
		    {
		        background-color: var(--primary);
		    }
		    
		    #roundName
		    {
		        text-transform: uppercase;
		    }
		    
		    #nextStateButton
		    {
		        pointer-events: auto;
		        color: lightblue;
		    }
		    
		    #counter
		    {
		        width: 128px;
		        height: 128px;
		        
		        background-color: var(--primary);
		        
		        border-radius: 100%;
		        border: 10px solid var(--outline);
		        
		        display: flex;
		        flex-direction: column;
		        align-items: center;
		        justify-content: flex-end;
		        
		        position: relative;
		        left: -26px;
		        
		        transition: background-color var(--color-fade-time), border-color var(--color-fade-time);
		    }
		    
		    #statue
		    {
		        background-color: var(--outline);
		        min-height: 72px;
		        width: 48px;
		        
		        border-radius: 10px;
		        
		        position: relative;
		        top: 10px;
		        
		        transition: background-color var(--color-fade-time), border-color var(--color-fade-time);
		    }
		    
		    #count
		    {
		        background-color: var(--outline);
		        border-radius: 10px;
		        padding: 5px;
		        font-size: 28px;
		        text-align: center;
		        
		        width: 38px;
		        
		        position: relative;
		        top: 20px;
		        
		        transition: background-color var(--color-fade-time), border-color var(--color-fade-time);
		    }
		    
		    #unitPlaceDialog
		    {
		        position: relative;
		        z-index: 9999999 !important;
		        
		        pointer-events: auto;
		        
		        padding: 20px;
		        border-radius: 10px;
		        
		        background-color: #222222aa;
		        color: white;
		        text-align: center;
		    }
		    
		    #unitPlaceDialog > h1
		    {
		        font-size: 14px;
		        margin: 0px;
		    }
		    
		    #unitPlaceDialog > div
		    {
		        margin-top: 10px;
		        margin-bottom: 5px;
		    }
		    
		    #unitPlaceDialog > div > input[type="range"]
		    {
		        width: 80%;
		    }
		    
		    #dropUnitAmountPreview
		    {
		        font-size: 20px;
		        padding-left: 5px;
		        position: relative;
		        top: -3px;
		    }
		    
		    #unitPlaceDialog > button
		    {
		        width: 100%;
		        font-size: 14px;
		        padding: 5px;
		    }
		    
		    /*
		    #dropUnitDialog
		    {
		        width: 80%;
		        height: 30%;
		        overflow-y: hidden;
		        
	            position: absolute;
		        z-index: 999999;
		        top: 35%;
		        left: 10%;
		        
		        display: flex;
		        align-items: center;
		        justify-content: center;
		        flex-direction: column;
		        
		        background-color: #222222aa;
		        color: white;
		        font-size: 40px;
		        
		        opacity: 0;
		        transform: scale(0.8);
		        
		        transition: opacity, 0.25s, transform 0.2s;
		    }
		    
		    #dropUnitDialog.open
		    {
		        opacity: 1;
		        transform: scale(1);
		    }
		    */
		</style>
	</head>
	
	<body>
	    <div id='gameInterfaceContainer'>
	        <div id='gameStatus' data-state='0'>
	            <div id='me'>
	                <div id='playerPortrait'></div>
	            </div>
	            <div id='roundStatus'>
	                <div>
	                    <span id='flag'></span>
	                    <span id='playerName'>Super Idiot</span>
	                    <span id='tags'>&#10004;</span>
	                </div>
	                <div id='roundType'>
	                    <div class='roundSpace active'></div>
	                    <div class='roundSpace'></div>
	                    <div class='roundSpace'></div>
	                </div>
	                <div>
    	                <span id='roundName'>
    	                    Place
    	                </span>
                        <a href='#' id='nextStateButton'>
                            next state
                        </a>
	                </div>
	            </div>
	            <div id='counter'>
	                <div id='statue'>
	                    
	                </div>
	                <div id='count'>
	                    
	                </div>
	            </div>
	        </div>
	    </div>
	    
	    <!--
	    <div id='dropUnitDialog'>
	        <div>How many units?</div>
	        <div>
	            <input type="range" min="1" max="4" value="2" class="slider" id="dropUnitAmount"> <span id='dropUnitAmountPreview'>0</span>
            </div>
            <div>
	            <button id='dropUnitButton'>Drop Units</button>
            </div>
	    </div>
	    -->
	    
		<script src="https://kerrishaus.com/assets/threejs/build/three.js"></script>
		
		<script type='module'>
		    import { CSS2DObject, CSS2DRenderer } from "https://kerrishaus.com/assets/threejs/examples/jsm/renderers/CSS2DRenderer.js";
		
			class WorldObject extends THREE.Mesh
			{
			    constructor(width, height, color)
			    {
			        const geometry = new THREE.BoxGeometry(width, height, 1);
			        const material = new THREE.MeshBasicMaterial({ color: color });
			        
			        super(geometry, material);
			        
			        this.hovered = false;
			        
			        this.objectOwner = -1;
			        this.unitCount = 1;
			        
    				const labelDiv = document.createElement("div");
    				labelDiv.id = this.uuid;
        			labelDiv.className = 'unitCount';
        			labelDiv.textContent = this.unitCount;
        			
        			this.label = new CSS2DObject(labelDiv);
        			this.label.color = "white";
        			this.add(this.label);
        			
        			this.userData.canClick = true;
        			
        			this.targetPosition = new THREE.Vector3(0, 0, 0);
        			
        			this.dialog = null;
			    }
			    
			    update(deltaTime)
			    {
			        this.position.lerp(this.targetPosition, 0.3);
			    }
			    
			    createUnitPlaceDialog(availableUnits)
			    {
			        if (this.availableUnits <= 0)
			        {
			            console.warn("No available units to place.");
			            return
			        }
			        
			        if (this.dialog)
			            this.destroyUnitPlaceDialog();
			        
    				const dialog = document.createElement("div");
        			dialog.id = 'unitPlaceDialog';
        			
        			const header = document.createElement("h1");
        			header.innerHTML = "How many units?";
        			dialog.append(header);
        			
        			const inputGroup = document.createElement("div");
        			dialog.append(inputGroup);
        			
        			const input = document.createElement("input");
        			input.id = 'dropUnitAmount';
        			input.type = 'range'
        			input.min = 1;
        			input.max = availableUnits;
        			input.value = availableUnits;
        			input.addEventListener("input", function(event)
        			{
        			    document.getElementById("dropUnitAmountPreview").innerHTML = this.value;
        			});
        			inputGroup.append(input);
        			
        			const inputCounter = document.createElement("span");
        			inputCounter.textContent = availableUnits;
        			inputCounter.id = 'dropUnitAmountPreview'
        			inputGroup.append(inputCounter);
        			
        			const button = document.createElement("button");
        			button.id = 'dropUnitButton';
        			button.textContent = "Place";
        			dialog.append(button);
        			
        			this.dialog = new CSS2DObject(dialog);
        			this.add(this.dialog);
			    }
			    
			    destroyUnitPlaceDialog()
			    {
        			this.remove(this.dialog);
        			this.dialog = null;
			    }
			    
			    raise()
			    {
			        this.targetPosition.z += 0.4;
			    }
			    
			    lower()
			    {
			        this.targetPosition.z -= 0.4;
			    }
			    
			    addUnits(amount = 1)
			    {
			        this.unitCount += amount;
			        $("#" + this.uuid).html(this.unitCount);
			    }
			    
			    removeUnits(amount = 1)
			    {
			        this.unitCount -= amount;
			        $("#" + this.uuid).html(this.unitCount);
			    }
			};
			
			class GameWorld extends THREE.Group
			{
			    constructor(width, height)
			    {
			        super();
			        
			        this.tiles = new Array(width * height);
			        
			        this.ownedTerritory = 0;
			        
		            for (let y = 0; y < height; y++)
			        {
			            for (let x = 0; x < width; x++)
			            {
                            function getRandomInt(max)
                            {
                                return Math.floor(Math.random() * max);
                            }
                            
                            let chance = getRandomInt(2);
                            
                            let color = 0x1b6b15;
			                if (chance > 0)
			                {
			                    color = 0x00ff00
			                    this.ownedTerritory += 1;
			                }
			                
			                const object = new WorldObject(2, 2, color);
			                object.targetPosition.x = x + 1.3 * x;
			                object.targetPosition.y = y + 1.3 * y;
			                object.targetPosition.z = 0;
			                object.userData.team = chance > 0 ? 1 : 2;
			                this.tiles[x + y * width] = object;
			                this.add(object);
			            }
			        }
			        
                    const floorGeometry = new THREE.PlaneGeometry(width + width * 1.3 + 3, height + height * 1.3 + 3);
                    const floorMaterial = new THREE.MeshBasicMaterial({color: 0x256d8f, side: THREE.FrontSide });
                    const floor = new THREE.Mesh(floorGeometry, floorMaterial);
                    floor.position.x = width / 2 + 1.1 * width / 2 - 0.7;
                    floor.position.y = height / 2 + 1.1 * height / 2 - 0.7;
                    this.add(floor);
			    }
			    
			    update(deltaTime)
			    {
			        for (const tile of this.tiles)
		                tile.update(deltaTime);
	            }
			};
			
			const scene = new THREE.Scene();
			const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.x = 5 + 0.3 * 5;
            camera.position.y = 5 + 0.3 * 5;
			camera.position.z = 14;
			
			const renderer = new THREE.WebGLRenderer();
			renderer.setSize(window.innerWidth, window.innerHeight);
			document.body.appendChild(renderer.domElement);
			
			const htmlRenderer = new CSS2DRenderer();
			htmlRenderer.setSize(window.innerWidth, window.innerHeight);
			htmlRenderer.domElement.style.position = 'absolute';
			htmlRenderer.domElement.style.top = '0px';
			document.body.appendChild(htmlRenderer.domElement).style.pointerEvents = "none";
			
			let raycaster = new THREE.Raycaster(), pointer = new THREE.Vector2, INTERSECTED;

			const clock = new THREE.Clock();
			
			window.addEventListener('resize', onWindowResize);
			
			document.addEventListener('keydown', onKeyDown);
			//document.addEventListener('keyup', onKeyUp);

            document.addEventListener('mouseup', onMouseUp);
            document.addEventListener('mousemove', onPointerMove);
            
            const world = new GameWorld(10, 5);
			scene.add(world);
			
			const states = [
                "Place",
                "Attack",
                "Move"
		    ];
		    
			let gameState = 0;
			
			let ownedTerritory = world.ownedTerritory;
			let availableUnits = Math.trunc(ownedTerritory / 3);
			$("#count").html(availableUnits);
            
            let selectedTerritory = null;
			
			$(htmlRenderer.domElement).on("click", "#dropUnitButton", function(event)
			{
			    event.preventDefault();
			    
			    console.log("place");
			    
			    const amount = parseInt($("#dropUnitAmount").val());
			    
			    if (amount <= 0)
		        {
			        console.error("No available units to drop.");
			        return;
			    }
			    
			    if (amount > availableUnits)
			    {
			        console.error("Requested to drop too many units.");
			        return;
			    }
			   
                availableUnits -= amount;
                scene.getObjectById(selectedTerritory).addUnits(amount);
                $("#count").html(availableUnits);
                dismissDropDialog();
			});
			
			$("body").on("click", "#nextStateButton", function(event)
			{
			    console.log("next state");
			    
			    event.preventDefault();
			    
			    if (gameState >= 2)
			        gameState = 0;
			    else
			        gameState += 1;
			        
			    $(".roundSpace.active").removeClass("active");
			    $("#roundType").children()[gameState].classList.add("active");
			    $("#roundName").html(states[gameState]);
			    
			    $("#gameStatus").attr("data-state", gameState);
			});
			
			function createDropDialog(id)
			{
			    if (selectedTerritory !== null)
			    {
			        console.warn("Unit drop dialog is already open");
			        return;
			    }
			    
			    if (availableUnits <= 0)
			    {
			        console.warn("No available units.");
			        return
			    }
			    
			    selectedTerritory = id;
			    
			    if (scene.getObjectById(id) == null)
			    {
			        console.error("Id passed in CreateDropDialog failed sanity check.");
			        return;
			    }
			    
			    INTERSECTED.createUnitPlaceDialog(availableUnits);
			}
			
			function dismissDropDialog()
			{
			    //$("#dropUnitDialog").removeClass("open");
			    //scene.getObjectById(selectedTerritory).lower();
			    
			    INTERSECTED.destroyUnitPlaceDialog();
			    
			    selectedTerritory = null;
			}
			
            function onMouseUp(event)
            {
                // FIXME: this is a bug.
                
                if (INTERSECTED == null)
                    return;
                    
                if (INTERSECTED.userData.team == 1)
                    createDropDialog(INTERSECTED.id);
            }
            
            function onKeyDown(event)
            {
                if (event.code == "Escape")
                    dismissDropDialog();
            }
			
            function onPointerMove(event)
            {
            	pointer.x = ( event.clientX / window.innerWidth ) * 2 - 1;
            	pointer.y = - ( event.clientY / window.innerHeight ) * 2 + 1;
            }
			
			function onWindowResize()
			{
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize(window.innerWidth, window.innerHeight);
				htmlRenderer.setSize(window.innerWidth, window.innerHeight);
			}
			
			function animate()
			{
				requestAnimationFrame(animate);
				
                if (selectedTerritory === null)
                {
                	raycaster.setFromCamera(pointer, camera);
                	const intersects = raycaster.intersectObjects(scene.children, true);
                
                	if (intersects.length > 0)
                	{
                		if (INTERSECTED != intersects[0].object)
                		{
                			if (INTERSECTED) // the object is no longer hovered, and we're hovering over another object
                			{
                			    INTERSECTED.material.color.setHex(INTERSECTED.currentHex);
                			    INTERSECTED.lower();
                			    INTERSECTED = null;
                			}
                
                            if (intersects[0].object.userData.hasOwnProperty("canClick")) // the object is now hovered
                            {
                                if (intersects[0].object.userData.team == 1)
                                {
                    				INTERSECTED = intersects[0].object;
                    				INTERSECTED.currentHex = INTERSECTED.material.color.getHex();
                    				INTERSECTED.material.color.setHex(0xff0000);
                    				
                    				INTERSECTED.raise();
                                }
                            }
                		}
                	}
                	else // the object is no longer hovered, and no object is hovered
                	{
                		if (INTERSECTED)
                		{
                		    INTERSECTED.material.color.setHex(INTERSECTED.currentHex);
                		    INTERSECTED.lower();
                		}
                
                		INTERSECTED = null;
                	}
                }
				
				world.update(clock.getElapsedTime());

				renderer.render(scene, camera);
				htmlRenderer.render(scene, camera);
			};

			animate();
		</script>
	</body>
</html>
